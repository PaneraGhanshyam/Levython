name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.3)"
        required: true
        default: "1.0.3"

env:
  APP_NAME: Levython
  APP_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  # ============================================================================
  # WINDOWS BUILD WITH INNO SETUP
  # ============================================================================
  build-windows:
    name: Build Windows (x64)
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-openssl
            make

      - name: Build Levython (Windows x64)
        shell: msys2 {0}
        run: |
          echo "Building Levython for Windows x64..."
          make CXX=clang++ CXXFLAGS="-std=c++17 -O3 -DNDEBUG"
          ls -lh levython.exe
          ./levython.exe --version || echo "Version check skipped"

      - name: Prepare Installer Assets
        shell: pwsh
        run: |
          # Create installer build directory
          New-Item -ItemType Directory -Force -Path "installer-build"

          # Copy executable
          Copy-Item "levython.exe" -Destination "installer-build/"

          # Copy logo/icon if exists
          if (Test-Path "icon.png") {
            Copy-Item "icon.png" -Destination "installer-build/logo.png"
          }

          # Copy examples
          if (Test-Path "examples") {
            Copy-Item -Recurse "examples" -Destination "installer-build/"
          }

          # Copy docs
          Copy-Item "README.md" -Destination "installer-build/" -ErrorAction SilentlyContinue
          Copy-Item "LICENSE" -Destination "installer-build/" -ErrorAction SilentlyContinue

          Write-Host "âœ“ Installer assets prepared"
          Get-ChildItem -Recurse installer-build

      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "Installing Inno Setup 6..."

          $InnoSetupUrl = "https://jrsoftware.org/download.php/is.exe"
          $InstallerPath = "$env:TEMP\innosetup-installer.exe"

          # Download Inno Setup
          Invoke-WebRequest -Uri $InnoSetupUrl -OutFile $InstallerPath

          # Install silently
          Start-Process -FilePath $InstallerPath -ArgumentList "/VERYSILENT","/SUPPRESSMSGBOXES","/NORESTART","/SP-" -Wait

          # Add to PATH
          $InnoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$InnoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "âœ“ Inno Setup installed"

      - name: Build Installer with Inno Setup
        shell: pwsh
        run: |
          Write-Host "Building Windows Installer..."

          # Verify Inno Setup is available
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            throw "Inno Setup compiler not found at: $iscc"
          }

          # Update version in ISS file if needed
          $issFile = "installer\levython-setup.iss"
          $issContent = Get-Content $issFile -Raw

          # Extract version from tag or input
          $version = "${{ env.APP_VERSION }}".TrimStart('v')
          Write-Host "Building version: $version"

          # Replace version in ISS file
          $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`""
          $issContent | Set-Content $issFile

          # Compile installer
          & $iscc $issFile /O"installer-output" /F"Levython-Setup-$version-x64"

          if ($LASTEXITCODE -ne 0) {
            throw "Inno Setup compilation failed with exit code: $LASTEXITCODE"
          }

          Write-Host "âœ“ Installer built successfully"
          Get-ChildItem installer-output

      - name: Create Portable ZIP
        shell: pwsh
        run: |
          Write-Host "Creating portable ZIP package..."

          $version = "${{ env.APP_VERSION }}".TrimStart('v')
          $zipName = "Levython-Portable-$version-x64-Windows.zip"

          Compress-Archive -Path "installer-build\*" -DestinationPath $zipName -Force

          Write-Host "âœ“ Portable ZIP created: $zipName"
          Get-Item $zipName

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-artifacts
          path: |
            installer-output/*.exe
            Levython-Portable-*.zip
          retention-days: 7

  # ============================================================================
  # MACOS BUILD (Universal Binary)
  # ============================================================================
  build-macos:
    name: Build macOS (Universal)
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          echo "Installing build dependencies..."
          brew update
          brew install openssl@3

          echo "âœ“ Dependencies installed"

      - name: Build Levython (x86_64)
        run: |
          echo "Building Levython for macOS (x86_64)..."
          make clean
          make CXX=clang++ CXXFLAGS="-std=c++17 -O3 -DNDEBUG -arch x86_64" \
               LDFLAGS="-L/usr/local/opt/openssl@3/lib" \
               OUT=levython-x86_64

          ls -lh levython-x86_64
          file levython-x86_64

      - name: Build Levython (arm64)
        run: |
          echo "Building Levython for macOS (arm64)..."
          make clean
          make CXX=clang++ CXXFLAGS="-std=c++17 -O3 -DNDEBUG -arch arm64" \
               LDFLAGS="-L/opt/homebrew/opt/openssl@3/lib" \
               OUT=levython-arm64

          ls -lh levython-arm64
          file levython-arm64

      - name: Create Universal Binary
        run: |
          echo "Creating Universal Binary..."
          lipo -create levython-x86_64 levython-arm64 -output levython

          chmod +x levython

          ls -lh levython
          file levython

          echo "âœ“ Universal binary created"

      - name: Create macOS Package
        run: |
          echo "Creating macOS distribution package..."

          version="${{ env.APP_VERSION }}"
          version="${version#v}"
          pkg_name="Levython-${version}-macOS-Universal"

          mkdir -p "${pkg_name}/bin"
          mkdir -p "${pkg_name}/examples"
          mkdir -p "${pkg_name}/docs"

          cp levython "${pkg_name}/bin/"
          cp icon.png "${pkg_name}/" 2>/dev/null || true
          cp README.md "${pkg_name}/docs/" 2>/dev/null || true
          cp LICENSE "${pkg_name}/docs/" 2>/dev/null || true

          if [ -d "examples" ]; then
            cp -r examples/* "${pkg_name}/examples/" 2>/dev/null || true
          fi

          cat > "${pkg_name}/install.sh" << 'EOFINSTALL'
          #!/bin/bash
          set -e
          echo "Installing Levython..."
          if [ "$EUID" -ne 0 ]; then
            echo "Please run with sudo: sudo ./install.sh"
            exit 1
          fi
          cp bin/levython /usr/local/bin/
          chmod +x /usr/local/bin/levython
          echo "âœ“ Levython installed to /usr/local/bin/levython"
          echo "  Run: levython --version"
          EOFINSTALL

          chmod +x "${pkg_name}/install.sh"

          hdiutil create -volname "${pkg_name}" -srcfolder "${pkg_name}" -ov -format UDZO "${pkg_name}.dmg"
          tar -czf "${pkg_name}.tar.gz" "${pkg_name}"

          ls -lh *.dmg *.tar.gz
          echo "âœ“ macOS packages created"

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-artifacts
          path: |
            Levython-*-macOS-Universal.dmg
            Levython-*-macOS-Universal.tar.gz
          retention-days: 7

  # ============================================================================
  # LINUX BUILD (x86_64)
  # ============================================================================
  build-linux:
    name: Build Linux (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          echo "Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            build-essential \
            libssl-dev \
            libasound2-dev \
            libx11-dev \
            libxtst-dev

          echo "âœ“ Dependencies installed"

      - name: Build Levython
        run: |
          echo "Building Levython for Linux x86_64..."
          make CXX=clang++ CXXFLAGS="-std=c++17 -O3 -DNDEBUG"

          ls -lh levython
          file levython
          ./levython --version || echo "Version check skipped"

          echo "âœ“ Build completed"

      - name: Create Linux Package
        run: |
          echo "Creating Linux distribution package..."

          version="${{ env.APP_VERSION }}"
          version="${version#v}"
          pkg_name="Levython-${version}-Linux-x86_64"

          mkdir -p "${pkg_name}/bin"
          mkdir -p "${pkg_name}/examples"
          mkdir -p "${pkg_name}/docs"

          cp levython "${pkg_name}/bin/"
          cp icon.png "${pkg_name}/" 2>/dev/null || true
          cp README.md "${pkg_name}/docs/" 2>/dev/null || true
          cp LICENSE "${pkg_name}/docs/" 2>/dev/null || true

          if [ -d "examples" ]; then
            cp -r examples/* "${pkg_name}/examples/" 2>/dev/null || true
          fi

          cat > "${pkg_name}/install.sh" << 'EOFINSTALL'
          #!/bin/bash
          set -e
          echo "Installing Levython..."
          if [ "$EUID" -ne 0 ]; then
            echo "Please run with sudo: sudo ./install.sh"
            exit 1
          fi
          cp bin/levython /usr/local/bin/
          chmod +x /usr/local/bin/levython
          echo "âœ“ Levython installed to /usr/local/bin/levython"
          echo "  Run: levython --version"
          EOFINSTALL

          chmod +x "${pkg_name}/install.sh"
          chmod +x "${pkg_name}/bin/levython"

          tar -czf "${pkg_name}.tar.gz" "${pkg_name}"

          deb_name="levython_${version}_amd64"
          mkdir -p "${deb_name}/DEBIAN"
          mkdir -p "${deb_name}/usr/local/bin"
          mkdir -p "${deb_name}/usr/share/doc/levython"

          cp levython "${deb_name}/usr/local/bin/"
          chmod +x "${deb_name}/usr/local/bin/levython"
          cp README.md "${deb_name}/usr/share/doc/levython/" 2>/dev/null || true
          cp LICENSE "${deb_name}/usr/share/doc/levython/copyright" 2>/dev/null || true

          cat > "${deb_name}/DEBIAN/control" << EOFCONTROL
          Package: levython
          Version: ${version}
          Section: devel
          Priority: optional
          Architecture: amd64
          Maintainer: Levython Authors <levythonhq@gmail.com>
          Description: High Performance JIT-Compiled Programming Language
           Levython is a high-performance, general-purpose programming language
           with an x86-64 JIT, a fast bytecode VM, and a practical standard library.
          Homepage: https://github.com/levython/levython
          EOFCONTROL

          dpkg-deb --build "${deb_name}"
          mv "${deb_name}.deb" "levython_${version}_amd64.deb"

          ls -lh *.tar.gz *.deb
          echo "âœ“ Linux packages created"

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64-artifacts
          path: |
            Levython-*-Linux-x86_64.tar.gz
            levython_*.deb
          retention-days: 7

  # ============================================================================
  # CREATE GITHUB RELEASE
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display Artifact Structure
        run: |
          echo "Downloaded artifacts:"
          ls -lhR artifacts/

      - name: Prepare Release Assets
        run: |
          mkdir -p release-assets

          find artifacts -type f \( -name "*.exe" -o -name "*.zip" -o -name "*.dmg" -o -name "*.tar.gz" -o -name "*.deb" \) -exec cp {} release-assets/ \;

          echo "Release assets:"
          ls -lh release-assets/

          cd release-assets
          sha256sum * > SHA256SUMS.txt
          cd ..

          echo "âœ“ Release assets prepared"

      - name: Generate Release Notes
        run: |
          version="${{ env.APP_VERSION }}"
          version="${version#v}"

          cat > RELEASE_NOTES.md << EOFNOTES
          # Levython ${version} - Release

          ## ðŸŽ‰ What's New

          This release includes builds for Windows, macOS, and Linux with professional installers and portable packages.

          ## ðŸ“¦ Installation

          ### Windows
          - **Recommended**: Download \`Levython-Setup-${version}-x64.exe\` and run the installer
          - **Portable**: Download \`Levython-Portable-${version}-x64-Windows.zip\` and extract

          ### macOS
          - **DMG**: Download \`Levython-${version}-macOS-Universal.dmg\` and drag to Applications
          - **Tarball**: Download \`Levython-${version}-macOS-Universal.tar.gz\` and run \`sudo ./install.sh\`

          ### Linux
          - **DEB Package**: \`sudo dpkg -i levython_${version}_amd64.deb\`
          - **Tarball**: Download \`Levython-${version}-Linux-x86_64.tar.gz\` and run \`sudo ./install.sh\`

          ## âœ… Verification

          After installation, verify with:
          \`\`\`bash
          levython --version
          \`\`\`

          ## ðŸ” Checksums

          See \`SHA256SUMS.txt\` for file integrity verification.

          ## ðŸ“§ Support

          For issues or questions, contact: levythonhq@gmail.com

          ## ðŸ”— Links

          - Documentation: https://levython.github.io/documentation/
          - Repository: https://github.com/levython/levython
          - License: MIT

          ---

          **Full Changelog**: https://github.com/levython/levython/compare/v${version}...HEAD
          EOFNOTES

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.APP_VERSION }}
          name: Levython ${{ env.APP_VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "::notice::âœ“ Release ${{ env.APP_VERSION }} created successfully!"
          echo "::notice::ðŸ“¦ Artifacts uploaded for Windows, macOS, and Linux"
          echo "::notice::ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/${{ env.APP_VERSION }}"
